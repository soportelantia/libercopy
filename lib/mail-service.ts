import formData from "form-data"
import Mailgun from "mailgun.js"

// Variables de configuraci√≥n - solo disponibles en el servidor
const MAILGUN_API_KEY = process.env.MAILGUN_API_KEY
const DOMAIN = process.env.MAILGUN_DOMAIN
const FROM_EMAIL = process.env.MAILGUN_FROM_EMAIL || "noreply@libercopy.es"
const NEXT_PUBLIC_SITE_URL = process.env.NEXT_PUBLIC_SITE_URL

// Solo hacer debug en el servidor
const isServer = typeof window === "undefined"

if (isServer) {
  console.log("üîß Mailgun configuration check (server-side):")
  console.log("- API Key:", MAILGUN_API_KEY ? `${MAILGUN_API_KEY.substring(0, 8)}...` : "NOT SET")
  console.log("- Domain:", DOMAIN || "NOT SET")
  console.log("- From Email:", FROM_EMAIL)
  console.log("- Environment:", process.env.NODE_ENV)
}

// Verificar si Mailgun est√° configurado (solo en servidor)
const isMailgunConfigured = isServer && Boolean(MAILGUN_API_KEY && DOMAIN)

if (isServer) {
  console.log("- Is Configured:", isMailgunConfigured)
}

// Inicializar Mailgun solo en el servidor
let mg: any = null
if (isServer && isMailgunConfigured) {
  try {
    console.log("üöÄ Initializing Mailgun client...")
    const mailgun = new Mailgun(formData)
    mg = mailgun.client({
      username: "api",
      key: MAILGUN_API_KEY!,
      url: "https://api.eu.mailgun.net"
    })
    console.log("‚úÖ Mailgun client initialized successfully")
  } catch (error) {
    console.error("‚ùå Error initializing Mailgun:", error)
  }
} else if (isServer) {
  console.log("‚ö†Ô∏è Mailgun not configured - missing required environment variables")
}

// Funci√≥n para calcular el total del pedido correctamente
function calculateOrderTotal(orderData: any): number {
  // Si ya existe total_amount y es mayor que 0, usarlo
  if (orderData.total_amount && orderData.total_amount > 0) {
    return orderData.total_amount
  }

  // Si no, calcular desde los items + gastos de env√≠o
  const itemsTotal =
    orderData.order_items?.reduce((sum: number, item: any) => {
      return sum + (item.price || 0)
    }, 0) || 0

  const shippingCost = orderData.shipping_cost || 0
  return itemsTotal + shippingCost
}

interface SendEmailParams {
  to: string
  subject: string
  html: string
  text?: string
}

export async function sendEmail({ to, subject, html, text }: SendEmailParams) {
  // Esta funci√≥n solo debe ejecutarse en el servidor
  if (!isServer) {
    console.error("‚ùå sendEmail called on client side - this should only run on server")
    return { success: false, error: "Email can only be sent from server" }
  }

  console.log("üìß sendEmail called with:", { to, subject: subject.substring(0, 50) + "..." })
  console.log("üìß isMailgunConfigured:", isMailgunConfigured)
  console.log("üìß mg client exists:", !!mg)

  // Si Mailgun no est√° configurado, solo logear y continuar
  if (!isMailgunConfigured) {
    console.log("üìß Email would be sent (Mailgun not configured):")
    console.log(`To: ${to}`)
    console.log(`Subject: ${subject}`)
    console.log("HTML content:", html.substring(0, 200) + "...")
    return { success: false, error: "Mailgun not configured" }
  }

  if (!mg) {
    console.error("‚ùå Mailgun client not initialized")
    return { success: false, error: "Mailgun client not initialized" }
  }

  try {
    console.log("üöÄ Sending email via Mailgun...")
    console.log("- Domain:", DOMAIN)
    console.log("- From:", FROM_EMAIL)
    console.log("- To:", to)

    const result = await mg.messages.create(DOMAIN!, {
      from: FROM_EMAIL,
      to: [to],
      subject,
      html,
      text: text || html.replace(/<[^>]*>/g, ""), // Fallback text version
    })

    console.log("‚úÖ Email sent successfully:", { to, subject, messageId: result.id })
    return { success: true, result }
  } catch (error) {
    console.error("‚ùå Error sending email:", error)
    console.error("‚ùå Error details:", {
      message: error instanceof Error ? error.message : "Unknown error",
      stack: error instanceof Error ? error.stack : undefined,
    })
    return { success: false, error }
  }
}

// Funci√≥n helper para verificar si el email est√° configurado
export function isEmailConfigured(): boolean {
  return isServer && isMailgunConfigured && mg !== null
}

// Funci√≥n para obtener el estado de configuraci√≥n
export function getMailgunStatus() {
  if (!isServer) {
    return {
      isConfigured: false,
      hasClient: false,
      domain: "N/A (client-side)",
      fromEmail: "N/A (client-side)",
      apiKeySet: false,
    }
  }

  return {
    isConfigured: isMailgunConfigured,
    hasClient: !!mg,
    domain: DOMAIN,
    fromEmail: FROM_EMAIL,
    apiKeySet: !!MAILGUN_API_KEY,
  }
}

// Plantilla base para emails
function getEmailTemplate(title: string, content: string) {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background-color: #2563eb; color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0; font-size: 24px;">LiberCopy</h1>
      </div>
      
      <div style="padding: 20px; border: 1px solid #ddd; border-top: none;">
        <h2>${title}</h2>
        ${content}
      </div>
      
      <div style="background-color: #f5f5f5; padding: 15px; text-align: center; font-size: 12px; color: #666;">
        <p>¬© ${new Date().getFullYear()} LiberCopy. Todos los derechos reservados.</p>
        <p>Si tienes alguna pregunta, cont√°ctanos respondiendo a este email.</p>
      </div>
    </div>
  `
}

// Plantilla de bienvenida para nuevos usuarios
export function getWelcomeEmail(firstName: string, url: string) {
  const content = `
    <p>¬°Hola ${firstName}!</p>

    <p>Gracias por registrarte en <strong>LiberCopy</strong>. Antes de empezar a usar tu cuenta, necesitamos que confirmes tu direcci√≥n de correo electr√≥nico.</p>

    <p>Haz clic en el siguiente bot√≥n para verificar tu cuenta:</p>

    <p style="margin: 30px 0;">
      <a href="${url}" style="background-color: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold;">
        Verificar cuenta
      </a>
    </p>

    <p>Si no te registraste en LiberCopy, puedes ignorar este mensaje.</p>

    <hr />

    <p>Una vez verifiques tu cuenta, podr√°s:</p>
    <ul>
      <li>Subir y imprimir tus documentos</li>
      <li>Elegir entre diferentes opciones de encuadernaci√≥n</li>
      <li>Hacer seguimiento de tus pedidos</li>
      <li>Gestionar tus direcciones de env√≠o</li>
    </ul>

    <p>¬°Gracias por confiar en nosotros!</p>
    <p>El equipo de LiberCopy</p>
  `

  return {
    subject: "LiberCopy - Confirma tu cuenta",
    html: getEmailTemplate("Confirma tu cuenta", content),
  }
}


// Plantilla de recuperaci√≥n de contrase√±a
export function getPasswordResetEmail(resetUrl: string, email?: string) {
  const content = `
    <p>Hemos recibido una solicitud para restablecer la contrase√±a de tu cuenta en LiberCopy.</p>
    
    <p>Si has sido t√∫, haz clic en el siguiente enlace para crear una nueva contrase√±a:</p>
    
    <div style="text-align: center; margin: 30px 0;">
      <a href="${resetUrl}" 
         style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">
        Restablecer contrase√±a
      </a>
    </div>
    
    <p><strong>Este enlace expirar√° en 1 hora por seguridad.</strong></p>
    
    <p>Si no has solicitado este cambio, puedes ignorar este email. Tu contrase√±a no se modificar√°.</p>
    
    <p>Por seguridad, nunca compartas este enlace con nadie.</p>
    
    <p>Tambi√©n puedes copiar y pegar este enlace en tu navegador:</p>
    <p style="word-break: break-all; background-color: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">${resetUrl}</p>
    
    <p>Saludos,<br>El equipo de LiberCopy</p>
  `

  return {
    subject: "LiberCopy - Restablece tu contrase√±a",
    html: getEmailTemplate("Restablece tu contrase√±a", content),
  }
}

// Plantilla de confirmaci√≥n de pedido (mejorada)
export function getOrderConfirmationEmail(orderData: any) {
  console.log("üìß getOrderConfirmationEmail called with data:", {
    orderId: orderData.id,
    hasOrderItems: !!orderData.order_items?.length,
    orderItemsCount: orderData.order_items?.length || 0,
    hasShippingAddresses: !!orderData.order_shipping_addresses?.length,
    shippingAddressesCount: orderData.order_shipping_addresses?.length || 0,
    shippingAddressesData: orderData.order_shipping_addresses,
    hasLegacyShippingAddress: !!orderData.shipping_address,
  })

  // DEBUG DETALLADO de los datos recibidos
  console.log("üîç DETAILED DEBUG - Order data structure:")
  console.log("- orderData keys:", Object.keys(orderData))
  console.log("- orderData.order_shipping_addresses:", orderData.order_shipping_addresses)
  console.log("- orderData.order_shipping_addresses type:", typeof orderData.order_shipping_addresses)
  console.log("- orderData.order_shipping_addresses length:", orderData.order_shipping_addresses?.length)

  if (orderData.order_shipping_addresses && orderData.order_shipping_addresses.length > 0) {
    console.log("- First shipping address:", orderData.order_shipping_addresses[0])
    console.log("- First shipping address keys:", Object.keys(orderData.order_shipping_addresses[0]))
  }

  // Tambi√©n verificar si hay datos en shipping_address (legacy)
  console.log("- orderData.shipping_address:", orderData.shipping_address)

  const { id, shipping_address, status, order_items } = orderData

  const isPaid = status === "completed" || status === "processing"
  const statusText = isPaid ? "Pagado" : "Pendiente de pago"

  // Funci√≥n para obtener el nombre legible de las opciones
  const getReadableOption = (key: string, value: string) => {
    const options: Record<string, Record<string, string>> = {
      paper_size: { a4: "A4", a3: "A3" },
      paper_type: { normal: "Normal", cardstock: "Cartulina", photo: "Fotogr√°fico" },
      paper_weight: {
        "80gsm": "80 g/m¬≤",
        "90gsm": "90 g/m¬≤",
        "100gsm": "100 g/m¬≤",
        "120gsm": "120 g/m¬≤",
        "160gsm": "160 g/m¬≤",
        "200gsm": "200 g/m¬≤",
        "250gsm": "250 g/m¬≤",
        "300gsm": "300 g/m¬≤",
      },
      print_type: { bw: "Blanco y negro", color: "Color", colorPro: "Color PRO" },
      print_form: { oneSided: "Una cara", doubleSided: "Doble cara" },
      orientation: { portrait: "Vertical", landscape: "Horizontal" },
      pages_per_side: { one: "Una p√°gina por cara", multiple: "M√∫ltiples p√°ginas por cara" },
      finishing: {
        none: "Sin acabado",
        stapled: "Grapado",
        twoHoles: "Dos taladros",
        laminated: "Plastificado",
        bound: "Encuadernado",
        fourHoles: "Cuatro taladros",
      },
    }

    return options[key]?.[value] || value
  }

  // Obtener informaci√≥n de direcci√≥n de env√≠o mejorada - CON DEBUG
  let addressInfo = ""

  console.log("üè† Processing shipping address data...")
  console.log("üè† orderData.order_shipping_addresses:", orderData.order_shipping_addresses)

  // Primero intentar con order_shipping_addresses (nueva estructura)
  if (
    orderData.order_shipping_addresses &&
    Array.isArray(orderData.order_shipping_addresses) &&
    orderData.order_shipping_addresses.length > 0
  ) {
    const shippingAddr = orderData.order_shipping_addresses[0]
    console.log("‚úÖ Using order_shipping_addresses data:", shippingAddr)

    addressInfo = `
  <div style="background-color: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #2563eb;">
    <h4 style="margin: 0 0 10px 0; color: #2563eb;">üìç Direcci√≥n de entrega</h4>
    <p style="margin: 5px 0;"><strong>${shippingAddr.recipient_name || ""}</strong></p>
    ${shippingAddr.company ? `<p style="margin: 5px 0; color: #666;">${shippingAddr.company}</p>` : ""}
    <p style="margin: 5px 0;">${shippingAddr.address_line_1 || ""}</p>
    ${shippingAddr.address_line_2 ? `<p style="margin: 5px 0; color: #666;">${shippingAddr.address_line_2}</p>` : ""}
    <p style="margin: 5px 0;"><strong>${shippingAddr.postal_code || ""}</strong> ${shippingAddr.city || ""}</p>
    <p style="margin: 5px 0;">${shippingAddr.province || ""}, ${shippingAddr.country || "Espa√±a"}</p>
    ${shippingAddr.phone ? `<p style="margin: 5px 0; color: #666;">üìû ${shippingAddr.phone}</p>` : ""}
    ${shippingAddr.email ? `<p style="margin: 5px 0; color: #666;">‚úâÔ∏è ${shippingAddr.email}</p>` : ""}
    ${shippingAddr.delivery_notes ? `<p style="margin: 10px 0 5px 0; padding: 8px; background-color: #fff3cd; border-radius: 4px; font-size: 14px;"><strong>Notas de entrega:</strong> ${shippingAddr.delivery_notes}</p>` : ""}
  </div>
`
  }
  // Fallback a shipping_address si existe (legacy)
  else if (orderData.shipping_address) {
    console.log("‚ö†Ô∏è Using legacy shipping_address data:", orderData.shipping_address)
    const shipping_address = orderData.shipping_address
    addressInfo = `
  <div style="background-color: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #2563eb;">
    <h4 style="margin: 0 0 10px 0; color: #2563eb;">üìç Direcci√≥n de entrega</h4>
    <p style="margin: 5px 0;"><strong>${shipping_address.recipient_name || ""}</strong></p>
    ${shipping_address.company ? `<p style="margin: 5px 0; color: #666;">${shipping_address.company}</p>` : ""}
    <p style="margin: 5px 0;">${shipping_address.address_line_1 || ""}</p>
    ${shipping_address.address_line_2 ? `<p style="margin: 5px 0; color: #666;">${shipping_address.address_line_2}</p>` : ""}
    <p style="margin: 5px 0;"><strong>${shipping_address.postal_code || ""}</strong> ${shipping_address.city || ""}</p>
    <p style="margin: 5px 0;">${shipping_address.province || ""}, ${shipping_address.country || "Espa√±a"}</p>
    ${shipping_address.phone ? `<p style="margin: 5px 0; color: #666;">üìû ${shipping_address.phone}</p>` : ""}
    ${shipping_address.email ? `<p style="margin: 5px 0; color: #666;">‚úâÔ∏è ${shipping_address.email}</p>` : ""}
  </div>
`
  } else {
    console.log("‚ùå No shipping address data found!")
    addressInfo = `
  <div style="background-color: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffc107;">
    <h4 style="margin: 0 0 10px 0; color: #2563eb;">‚ö†Ô∏è Direcci√≥n de entrega</h4>
    <p style="margin: 5px 0; color: #2563eb;">No se encontr√≥ informaci√≥n de direcci√≥n de entrega para este pedido.</p>
  </div>
`
  }

  console.log("üè† Address info generated:", addressInfo ? "‚úÖ Generated" : "‚ùå Empty")

  // Lista de elementos del pedido con todas las caracter√≠sticas
  const itemsList =
    order_items
      ?.map(
        (item: any) => `
    <tr>
      <td style="padding: 15px; border-bottom: 2px solid #f0f0f0; vertical-align: top;">
        <div style="margin-bottom: 8px;">
          <strong style="color: #2563eb; font-size: 16px;">üìÑ ${item.file_name || "Documento"}</strong>
        </div>
        
        <div style="background-color: #f8f9fa; padding: 12px; border-radius: 6px; margin: 8px 0;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
            <div><strong>üìä P√°ginas:</strong> ${item.page_count || 0}</div>
            <div><strong>üìã Copias:</strong> ${item.copies || 1}</div>
            <div><strong>üìè Tama√±o:</strong> ${getReadableOption("paper_size", item.paper_size)}</div>
            <div><strong>üìÑ Papel:</strong> ${getReadableOption("paper_type", item.paper_type)}</div>
            ${item.paper_weight ? `<div><strong>‚öñÔ∏è Grosor:</strong> ${getReadableOption("paper_weight", item.paper_weight)}</div>` : ""}
            <div><strong>üé® Impresi√≥n:</strong> ${getReadableOption("print_type", item.print_type)}</div>
            <div><strong>üìë Caras:</strong> ${getReadableOption("print_form", item.print_form)}</div>
            <div><strong>üîÑ Orientaci√≥n:</strong> ${getReadableOption("orientation", item.orientation)}</div>
            <div><strong>üìñ P√°g/cara:</strong> ${getReadableOption("pages_per_side", item.pages_per_side)}</div>
            <div><strong>‚ú® Acabado:</strong> ${getReadableOption("finishing", item.finishing)}</div>
          </div>
          
          ${
            item.comments
              ? `
            <div style="margin-top: 10px; padding: 8px; background-color: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
              <strong style="color: #2563eb;">üí¨ Comentarios:</strong>
              <div style="color: #856404; font-size: 13px; margin-top: 4px;">${item.comments}</div>
            </div>
          `
              : ""
          }
        </div>
        
        <div style="font-size: 12px; color: #666; margin-top: 8px;">
          üíæ Tama√±o del archivo: ${item.file_size ? `${(item.file_size / 1024 / 1024).toFixed(2)} MB` : "N/A"}
        </div>
      </td>
      <td style="padding: 15px; border-bottom: 2px solid #f0f0f0; text-align: right; vertical-align: top;">
        <div style="font-size: 18px; font-weight: bold; color: #2563eb;">
          ${((item.price || 0) * (item.copies || 1)).toFixed(2)}‚Ç¨
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 4px;">
          ${(item.price || 0).toFixed(2)}‚Ç¨ √ó ${item.copies || 1}
        </div>
      </td>
    </tr>
  `,
      )
      .join("") || ""

  const content = `
    <p>¬°Gracias por tu pedido!</p>
    
    <p>Hemos recibido tu pedido correctamente. A continuaci√≥n te mostramos los detalles:</p>
    
    <div style="background-color: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 8px; border: 2px solid #e9ecef;">
      <h3 style="margin: 0 0 15px 0; color: #2563eb;">üìã Resumen del pedido</h3>
      <p style="margin: 8px 0;"><strong>N√∫mero de pedido:</strong> <span style="font-family: monospace; background-color: #e9ecef; padding: 4px 8px; border-radius: 4px;">#${id.substring(0, 8)}</span></p>
      <p style="margin: 8px 0;"><strong>Estado:</strong> <span style="color: ${isPaid ? "#22c55e" : "#f59e0b"}; font-weight: bold;">${statusText}</span></p>
      <p style="margin: 8px 0;"><strong>Total:</strong> <span style="font-size: 18px; font-weight: bold; color: #2563eb;">${calculateOrderTotal(orderData).toFixed(2)}‚Ç¨</span> <span style="font-size: 12px; color: #666;">(IVA incluido)</span></p>
    </div>
    
    ${addressInfo}
    
    ${
      itemsList
        ? `
    <div style="margin: 25px 0;">
      <h3 style="color: #2563eb; margin-bottom: 15px;">üõçÔ∏è Elementos del pedido</h3>
      <table style="width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
        ${itemsList}
        ${
          orderData.shipping_cost > 0
            ? `
        <tr style="background-color: #f8f9fa;">
          <td style="padding: 15px; border-bottom: 1px solid #e9ecef;">
            <strong>üöö Gastos de env√≠o</strong>
          </td>
          <td style="padding: 15px; border-bottom: 1px solid #e9ecef; text-align: right;">
            <strong>${orderData.shipping_cost.toFixed(2)}‚Ç¨</strong>
          </td>
        </tr>
        `
            : ""
        }
        <tr style="background-color: #2563eb; color: white;">
          <td style="padding: 20px; font-weight: bold; font-size: 16px;">üí∞ TOTAL</td>
          <td style="padding: 20px; text-align: right; font-weight: bold; font-size: 18px;">
            ${calculateOrderTotal(orderData).toFixed(2)}‚Ç¨
          </td>
        </tr>
      </table>
    </div>
    `
        : ""
    }
    
    <p>Puedes consultar el estado de tu pedido en cualquier momento desde tu cuenta en nuestra web:</p>
    
    <div style="text-align: center; margin: 30px 0;">
      <a href="${process.env.NEXT_PUBLIC_SITE_URL}/account/orders" 
         style="background-color: #2563eb; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 16px;">
        üë§ Ver mis pedidos
      </a>
    </div>
    
    ${
      !isPaid
        ? `
    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0;">
      <p style="margin: 0; color: #856404;"><strong>‚ö†Ô∏è Importante:</strong> Tu pedido est√° pendiente de pago. Por favor, completa el pago para que podamos procesarlo.</p>
    </div>
    `
        : `
    <div style="background-color: #d1edff; border: 1px solid #74b9ff; padding: 15px; border-radius: 8px; margin: 20px 0;">
      <p style="margin: 0; color: #0984e3;"><strong>‚úÖ ¬°Perfecto!</strong> Tu pedido ha sido pagado y est√° siendo procesado. Te mantendremos informado del estado.</p>
    </div>
    `
    }
    
    <p>Si tienes alguna pregunta, no dudes en contactarnos.</p>
    
    <p>Saludos,<br>El equipo de LiberCopy</p>
  `

  return {
    subject: `LiberCopy - Confirmaci√≥n de pedido #${id.substring(0, 8)}`,
    html: getEmailTemplate("Confirmaci√≥n de pedido", content),
  }
}
